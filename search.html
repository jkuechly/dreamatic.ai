<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Search - Search Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        h1, h2 {
            color: #bb86fc;
            text-align: center;
        }
        #searchForm {
            display: flex;
            flex-direction: column;
        }
        input, button {
            margin: 10px 0;
            padding: 8px;
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 4px;
        }
        button {
            background-color: #03dac6;
            color: #000000;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #018786;
        }
        #loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        .result-item {
            background-color: #2c2c2c;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .result-info {
            flex-grow: 1;
        }
        .result-distance {
            background-color: #03dac6;
            color: #000000;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        #downloadButton {
            margin-top: 20px;
            background-color: #bb86fc;
            color: #000000;
        }
        #downloadButton:hover {
            background-color: #985eff;
        }
        #downloadNotification {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #searchSummary {
            background-color: #2c2c2c;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            text-align: center;
        }
        #pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        #pagination button {
            margin: 0 5px;
        }
        #currentPage {
            margin: 0 10px;
            line-height: 38px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Search Businesses</h1>
        <form id="searchForm">
            <input type="text" id="keyword" name="keyword" required placeholder="Keyword (e.g., dentist)">
            <input type="text" id="location" name="location" required placeholder="Location">
            <input type="number" id="radius" name="radius" required min="1" max="100" value="10" placeholder="Radius (miles)">
            <button type="submit">Search</button>
        </form>
        <div id="loading">Searching...</div>
        <div id="results"></div>
        <div id="map" style="height: 400px; width: 100%; margin-top: 20px;"></div>
    </div>
    
    <div id="downloadNotification">Download successful!</div>
    
   <script>
    let searchResults = [];
    let currentPage = 1;
    const resultsPerPage = 5;

    document.addEventListener('DOMContentLoaded', function() {
        const searchForm = document.getElementById('searchForm');
        const loadingDiv = document.getElementById('loading');
        
        if (searchForm) {
            searchForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const keyword = document.getElementById('keyword').value;
                const location = document.getElementById('location').value;
                const radius = document.getElementById('radius').value;

                loadingDiv.style.display = 'block';
                
                try {
                    const [response] = await Promise.all([
                        fetch('/.netlify/functions/fetchSheetData', {
                            method: 'POST',
                            body: JSON.stringify({ keyword, location, radius })
                        }),
                        new Promise(resolve => setTimeout(resolve, 2000))
                    ]);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('Received data:', data);  // Log the received data
                    if (data.results && Array.isArray(data.results)) {
                        searchResults = data.results;
                        displayResults({
                            results: data.results,
                            searchParams: { keyword, location, radius }
                        });
                    } else {
                        throw new Error('Invalid data structure received');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred while searching. Please try again.');
                } finally {
                    loadingDiv.style.display = 'none';
                }
            });
        } else {
            console.error('Search form not found');
        }
    });

    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        if (resultsDiv) {
            // Display search summary
            const searchSummary = document.createElement('div');
            searchSummary.id = 'searchSummary';
            searchSummary.innerHTML = `
                <p>Showing results for "${data.searchParams.keyword}" 
                within ${data.searchParams.radius} miles of ${data.searchParams.location}</p>
            `;
            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(searchSummary);

            // Display results with pagination
            displayResultsPage(currentPage);

            // Add download button
            const downloadButton = document.createElement('button');
            downloadButton.id = 'downloadButton';
            downloadButton.textContent = 'Download Results';
            downloadButton.onclick = downloadResults;
            resultsDiv.appendChild(downloadButton);
        } else {
            console.error('Results div not found');
        }
    }

    function displayResultsPage(page) {
        const resultsDiv = document.getElementById('results');
        const startIndex = (page - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;
        const pageResults = searchResults.slice(startIndex, endIndex);

        pageResults.forEach(result => {
            const resultItem = document.createElement('div');
            resultItem.className = 'result-item';
            resultItem.innerHTML = `
                <div class="result-info">
                    <h3>${result.name}</h3>
                    <p>${result.address}</p>
                    <p>Phone: ${result.phone}</p>
                    <p>Website: <a href="${result.website}" target="_blank">${result.website}</a></p>
                    <p>Latitude: ${result.latitude}</p>
                    <p>Longitude: ${result.longitude}</p>
                </div>
            `;
            resultsDiv.appendChild(resultItem);
        });

        // Add pagination controls
        const paginationDiv = document.createElement('div');
        paginationDiv.id = 'pagination';
        paginationDiv.innerHTML = `
            <button onclick="changePage(-1)" ${page === 1 ? 'disabled' : ''}>Previous</button>
            <span id="currentPage">Page ${page} of ${Math.ceil(searchResults.length / resultsPerPage)}</span>
            <button onclick="changePage(1)" ${endIndex >= searchResults.length ? 'disabled' : ''}>Next</button>
        `;
        resultsDiv.appendChild(paginationDiv);
    }

    function changePage(delta) {
        currentPage += delta;
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '';
        displayResults({ searchParams: { keyword: document.getElementById('keyword').value, 
                                         location: document.getElementById('location').value, 
                                         radius: document.getElementById('radius').value }, 
                         results: searchResults });
    }

    function downloadResults() {
        if (searchResults.length === 0) {
            alert('No results to download. Please perform a search first.');
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Name,Address,Phone,Website,Latitude,Longitude\n";
        
        searchResults.forEach(result => {
            csvContent += `"${result.name}","${result.address}","${result.phone}","${result.website}","${result.latitude}","${result.longitude}"\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "search_results.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Show download notification
        showDownloadNotification();
    }

    function showDownloadNotification() {
        const notification = document.getElementById('downloadNotification');
        notification.style.display = 'block';
        notification.style.opacity = '1';

        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 500);
        }, 3000);
    }
    </script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCuqaLW8xNgBwSWatNnTR2c7U5as1TCqv8&libraries=places"></script>
    <script src="map.js"></script>
    
</body>
</html>
